#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

PROG=/usr/bin/ech-wk

start_service() {
	config_load ech-wk
	
	local enabled
	config_get_bool enabled general enabled 0
	[ "$enabled" -eq 1 ] || return 0

	local listen_addr server_addr server_ip token dns_server ech_domain
	config_get listen_addr general listen_addr '127.0.0.1:30000'
	config_get server_addr general server_addr
	config_get server_ip general server_ip
	config_get token general token
	config_get dns_server general dns_server 'dns.alidns.com/dns-query'
	config_get ech_domain general ech_domain 'cloudflare-ech.com'

	if [ -z "$server_addr" ]; then
		echo "ech-wk: server_addr is required"
		return 1
	fi

	procd_open_instance
	procd_set_param command "$PROG"
	procd_append_param command -l "$listen_addr"
	procd_append_param command -f "$server_addr"
	[ -n "$server_ip" ] && procd_append_param command -ip "$server_ip"
	[ -n "$token" ] && procd_append_param command -token "$token"
	[ -n "$dns_server" ] && procd_append_param command -dns "$dns_server"
	[ -n "$ech_domain" ] && procd_append_param command -ech "$ech_domain"

	procd_set_param respawn
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}
